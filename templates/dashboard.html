<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OpenAlgo Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
  <style>
    body { font-family: Arial; margin: 0; padding: 0; background-color: #f5f5f5; }
    header { background: #343a40; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    nav button { background: none; border: none; color: white; margin-right: 20px; font-size: 16px; cursor: pointer; }
    nav button:hover { text-decoration: underline; }
    .content { padding: 20px; }
    .section { display: none; }
    .active { display: block; }
    .btn { padding: 8px 14px; margin: 8px 0; background: #007BFF; color: white; border: none; cursor: pointer; border-radius: 4px; }
    .btn:hover { background: #0056b3; }
    .toggle input { margin-right: 10px; transform: scale(1.5); }
    input[type=text] { padding: 6px; width: 300px; margin-bottom: 10px; }
  </style>
</head>
<body>

<header>
  <nav>
    <button onclick="showTab('orders')">📊 Orders</button>
    <button onclick="showTab('zerodha')">🔐 Zerodha</button>
    <button onclick="showTab('copy')">🔁 Copy Trade</button>
    <button onclick="showTab('telegram')">📩 Telegram</button>
  </nav>
  <button class="btn" onclick="loginAll()">🔄 Login All</button>
</header>

<div class="content">

  <!-- ORDERS TAB -->
  <div id="orders" class="section active">
    <h2>📊 Orders Panel (Coming Soon...)</h2>
    <p>Live orders and summary will appear here.</p>
  </div>

  <!-- ZERODHA LOGIN TAB -->
  <div id="zerodha" class="section">
    <h2>🔐 Login to Zerodha Accounts</h2>
    <div id="loginButtons"></div>
    <select id="accountSelector">
      <option value="">-- Select Account --</option>
    </select>
    <button onclick="loginSelectedAccount()">Login</button>
  </div>

  <!-- COPY TRADE TAB -->
  <div id="copy" class="section">
    <h2>🔁 Copy Trading Settings</h2>
    <div class="toggle">
      <label for="copyToggle">Enable Copy Trading:</label>
      <input type="checkbox" id="copyToggle">
    </div>

    <h3>👑 Promote Child to Master</h3>
    <div>
      <label for="new-master">Switch Master to:</label>
      <select id="new-master"></select>
      <button onclick="makeNewMaster()">Set as Master</button>
    </div>
    <div id="childList"></div>
  </div>

  <!-- TELEGRAM TAB -->
  <div id="telegram" class="section">
    <h2>📩 Telegram Alert Settings</h2>
    <label>Bot Token:</label><br>
    <input type="text" id="bot_token" placeholder="123456:ABC-DEF1234ghIkl..."><br>
    <label>Chat ID:</label><br>
    <input type="text" id="chat_id" placeholder="-1001234567890"><br>
    <button class="btn" onclick="saveTelegram()">💾 Save Telegram Config</button>
  </div>

</div>

<script>
function showTab(tabId) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
}

function loadAccounts() {
  fetch('/config.yaml')
    .then(res => res.text())
    .then(text => {
      const names = [...text.matchAll(/- name: (\w+)/g)].map(m => m[1]);
      const masterMatch = text.match(/master:\s*\n\s*name:\s*(\w+)/);
      const master = masterMatch ? masterMatch[1] : "master";

      const loginDiv = document.getElementById('loginButtons');
      const selector = document.getElementById('accountSelector');
      const promote = document.getElementById('new-master');
      loginDiv.innerHTML = '';
      selector.innerHTML = `<option value="${master}">Master: ${master}</option>`;
      promote.innerHTML = '';

      names.forEach(name => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = `Login: ${name}`;
        btn.onclick = () => window.open(`/zerodha-login/${name}`, '_blank');
        loginDiv.appendChild(btn);

        selector.innerHTML += `<option value="${name}">Child: ${name}</option>`;
        promote.innerHTML += `<option value="${name}">${name}</option>`;
      });
    });
}

function loginSelectedAccount() {
  const account = document.getElementById("accountSelector").value;
  if (account) window.location.href = `/zerodha-login/${account}`;
}

function toggleCopyTrading(state) {
  fetch('/toggle-copy-trading', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ enabled: state })
  }).then(res => res.json()).then(data => alert("Copy Trading is now: " + (data.copy_trading ? "ON" : "OFF")));
}

document.getElementById("copyToggle").addEventListener('change', function () {
  toggleCopyTrading(this.checked);
});

fetch('/settings.yaml')
  .then(res => res.text())
  .then(text => document.getElementById('copyToggle').checked = text.includes("copy_trading: true"));

function loginAll() {
  fetch('/config.yaml')
    .then(res => res.text())
    .then(text => {
      const all = [...text.matchAll(/- name: (\w+)/g)].map(m => m[1]);
      const masterMatch = text.match(/master:\s*\n\s*name:\s*(\w+)/);
      if (masterMatch) all.push(masterMatch[1]);
      all.forEach(name => window.open(`/zerodha-login/${name}`, '_blank'));
    });
}

function saveTelegram() {
  const bot = document.getElementById('bot_token').value;
  const chat = document.getElementById('chat_id').value;
  fetch('/save-telegram', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ bot_token: bot, chat_id: chat })
  }).then(res => res.text()).then(alert);
}

function makeNewMaster() {
  const newMaster = document.getElementById("new-master").value;
  if (!newMaster) return alert("❗ Select a child account");
  fetch(`/make-master/${newMaster}`, { method: 'POST' })
    .then(r => r.text())
    .then(alert)
    .then(loadAccounts);
}

loadAccounts();
</script>
</body>
</html>
