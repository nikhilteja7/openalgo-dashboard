<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OpenAlgo Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <style>
    body { display: flex; margin: 0; font-family: Arial; background-color: #f0f2f5; }
    aside { width: 220px; background-color: #1c1c1c; color: white; height: 100vh; padding-top: 20px; position: fixed; }
    aside h2 { text-align: center; color: #61dafb; }
    aside ul { list-style: none; padding: 0; }
    aside li { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #444; }
    aside li:hover { background-color: #333; }
    main { margin-left: 220px; padding: 20px; flex-grow: 1; }
    section { display: none; }
    section.active { display: block; }
    .status-box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .status-box h3 { margin-top: 0; }
    .btn { background: #007BFF; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #0056b3; }
    .account-row { margin-top: 10px; }
    select, input { margin-top: 5px; padding: 6px; border-radius: 4px; border: 1px solid #ccc; width: 200px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #007BFF; color: white; }
    iframe { border: none; margin-top: 10px; }
    .live-orders { font-size: 14px; margin-top: 5px; color: #555; }
  </style>
</head>
<body>
  <aside>
    <h2>OpenAlgo</h2>
    <ul>
      <li onclick="showTab('copy')"><i class="fa-solid fa-repeat"></i> Copy Trading</li>
      <li onclick="showTab('login')"><i class="fa-solid fa-lock"></i> Zerodha Login</li>
      <li onclick="showTab('orders')"><i class="fa-solid fa-chart-column"></i> Orders</li>
      <li onclick="showTab('telegram')"><i class="fa-solid fa-envelope"></i> Telegram</li>
      <li onclick="confirmLogout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</li>
    </ul>
  </aside>

  <main>
    <section id="copy" class="active">
      <div class="status-box">
        <h3><i class="fa-solid fa-repeat"></i> Copy Trading Settings</h3>
        <label><input type="checkbox" id="copyToggle"> Enable Copy Trading</label><br><br>
        <label>Promote Child to Master:</label><br>
        <select id="new-master"></select><br><br>
        <button class="btn" onclick="makeNewMaster()">Set as Master</button>
        <button class="btn" onclick="undoMasterSwap()" style="margin-left: 10px; background-color: #6c757d;">Undo Master</button>
      </div>
    </section>

    <section id="login">
      <div class="status-box">
        <h3><i class="fa-solid fa-lock"></i> Login to Zerodha</h3>
        <div id="loginButtons"></div>
        <div id="accountStatus"></div>
      </div>
    </section>

    <section id="orders">
      <div class="status-box">
        <h3><i class="fa-solid fa-chart-column"></i> Chartink Trigger Log</h3>
        <p>Status: <span id="status">Waiting...</span></p>
        <p>Alert: <span id="alert_name">-</span></p>
        <div id="triggered_stocks"></div>
        <div id="chart_preview"></div>
        <a href="/download-log" class="btn" target="_blank"><i class="fa-solid fa-download"></i> Download Trigger Log</a>
        <table>
          <thead>
            <tr>
              <th>Account</th>
              <th>Order ID</th>
              <th>Status</th>
              <th>P&L</th>
            </tr>
          </thead>
          <tbody id="orderTable"></tbody>
        </table>
        <div style="margin-top: 20px; font-weight: bold;">Total P&L: ‚Çπ<span id="totalPnl">0.00</span></div>
        <h4 style="margin-top: 30px;">üìù Manual Order</h4>
        <label>Account:</label><br>
        <select id="manualAccount"></select><br>
        <label>Stock:</label><br>
        <input type="text" id="manualStock" placeholder="RELIANCE"><br>
        <label>Quantity:</label><br>
        <input type="number" id="manualQty" value="1"><br>
        <label>Side:</label><br>
        <select id="manualSide">
          <option value="BUY">BUY</option>
          <option value="SELL">SELL</option>
        </select><br><br>
        <button class="btn" onclick="sendManualOrder()">üöÄ Place Order</button>
      </div>
    </section>

    <section id="telegram">
      <div class="status-box">
        <h3><i class="fa-solid fa-envelope"></i> Telegram Setup</h3>
        <label>Bot Token:</label><br>
        <input type="text" id="bot_token"><br>
        <label>Chat ID:</label><br>
        <input type="text" id="chat_id"><br>
        <button class="btn" onclick="saveTelegram()">Save</button>
      </div>
    </section>
  </main>

  <script>
    const socket = io();
    socket.on("update_pnl", (data) => updatePnl(data.pnl));
    socket.on("new_order", (data) => addOrderRow(data));

    function showTab(id) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function makeNewMaster() {
      const newMaster = document.getElementById("new-master").value;
      if (!newMaster) return alert("Select a child account");
      fetch(`/make-master/${newMaster}`, { method: 'POST' })
        .then(r => r.text()).then(alert);
    }

    function undoMasterSwap() {
      fetch(`/undo-master`, { method: 'POST' })
        .then(r => r.text()).then(alert);
    }

    function saveTelegram() {
      const bot = document.getElementById('bot_token').value;
      const chat = document.getElementById('chat_id').value;
      fetch('/save-telegram', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bot_token: bot, chat_id: chat })
      }).then(res => res.text()).then(alert);
    }

    function toggleAccount(account, isEnabled) {
      fetch(`/toggle-account/${account}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled: isEnabled })
      }).then(r => r.text()).then(alert);
    }

    function sendManualOrder() {
      const data = {
        stock: document.getElementById("manualStock").value.trim().toUpperCase(),
        qty: document.getElementById("manualQty").value,
        action: document.getElementById("manualSide").value,
        account: document.getElementById("manualAccount").value
      };
      fetch("/manual-order", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(res => res.json()).then(res => alert("Manual Order: " + res.status));
    }

    function updatePnl(pnlValue) {
      document.getElementById("totalPnl").textContent = parseFloat(pnlValue).toFixed(2);
    }

    function addOrderRow(data) {
      const table = document.getElementById("orderTable");
      const row = document.createElement("tr");
      row.innerHTML = `<td>${data.account || "Master"}</td><td>${data.order_id || "-"}</td><td>${data.status || "Executed"}</td><td>${data.pnl ? '‚Çπ' + data.pnl.toFixed(2) : '-'}</td>`;
      table.prepend(row);
      const statusBox = document.getElementById(`status-${data.account}`);
      if (statusBox) statusBox.textContent = `Last order at ${data.time}`;
    }

    function loadAccounts() {
      fetch('/config.yaml')
        .then(res => res.text())
        .then(text => {
          const names = [...text.matchAll(/- name: (\w+)/g)].map(m => m[1]);
          const masterMatch = text.match(/master:\s*\n\s*name:\s*(\w+)/);
          const master = masterMatch ? masterMatch[1] : "master";

          const loginDiv = document.getElementById('loginButtons');
          const promote = document.getElementById('new-master');
          const manual = document.getElementById('manualAccount');
          loginDiv.innerHTML = '';
          promote.innerHTML = '';
          manual.innerHTML = '';

          const masterBtn = document.createElement('button');
          masterBtn.className = 'btn';
          masterBtn.textContent = `Login: ${master}`;
          masterBtn.onclick = () => window.open(`/zerodha-login/${master}`, '_blank');
          loginDiv.appendChild(masterBtn);
          manual.innerHTML += `<option value="${master}">${master} (master)</option>`;

          names.forEach(name => {
            const div = document.createElement('div');
            div.className = 'account-row';
            div.innerHTML = `
              <button class="btn" onclick="window.open('/zerodha-login/${name}', '_blank')">Login: ${name}</button>
              <label><input type="checkbox" onchange="toggleAccount('${name}', this.checked)" checked> Enabled</label>
              <div class="live-orders" id="status-${name}">-</div>
            `;
            loginDiv.appendChild(div);
            promote.innerHTML += `<option value="${name}">${name}</option>`;
            manual.innerHTML += `<option value="${name}">${name}</option>`;
          });
        });
    }

    function confirmLogout() {
      if (confirm("Are you sure you want to logout?")) {
        window.location.href = "/logout";
      }
    }

    loadAccounts();
  </script>
</body>
</html>
