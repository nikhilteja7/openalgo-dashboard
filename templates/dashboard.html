<!-- Save as templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OpenAlgo Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { font-family: Arial; margin: 0; background: #f0f2f5; }
    aside { width: 220px; background: #1c1c1c; color: white; height: 100vh; position: fixed; }
    aside h2 { text-align: center; padding: 15px 0; color: #61dafb; }
    aside ul { list-style: none; padding: 0; }
    aside li { padding: 15px 20px; border-bottom: 1px solid #333; cursor: pointer; }
    aside li:hover, aside li.active { background: #333; }
    header { position: fixed; top: 0; left: 220px; right: 0; background: #fff; padding: 10px 20px; display: flex; justify-content: flex-end; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    header select { padding: 6px; }
    main { margin-left: 220px; padding: 80px 20px 20px; }
    .section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none; }
    .section.active { display: block; }
    .btn { padding: 6px 12px; background: #007BFF; color: white; border: none; border-radius: 4px; margin: 4px; cursor: pointer; }
    .btn:hover { background: #0056b3; }
    input, select { margin: 5px 0; padding: 6px; width: 220px; }
    .card { background: #f9f9f9; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; }
    .green { color: green; }
    .red { color: red; }
    #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 12px 20px; border-radius: 6px; display: none; z-index: 1000; }
  </style>
</head>
<body>

<aside>
  <h2>OpenAlgo</h2>
  <ul>
    <li onclick="showTab('accountConfig')" class="active">Account Configuration</li>
    <li onclick="showTab('copyTrading')">Copy Trading</li>
  </ul>
</aside>

<header>
  <select onchange="handleDropdown(this.value)">
    <option hidden selected>‚ãÆ</option>
    <option>User Dashboard</option>
    <option>Security Settings</option>
    <option>Logout</option>
  </select>
</header>

<main>
  <!-- ACCOUNT CONFIGURATION -->
  <div id="accountConfig" class="section active">
    <h3>‚ûï Add Zerodha Account</h3>
    <input id="clientId" placeholder="Client ID (unique)" />
    <input id="apiKey" placeholder="API Key" />
    <input id="apiSecret" placeholder="API Secret" />
    <input id="totpKey" placeholder="TOTP Key" />
    <input id="emailId" placeholder="Email (optional)" />
    <input id="mobileNo" placeholder="Mobile (optional)" />
    <button class="btn" onclick="addAccount()">Add Account</button>

    <h4>‚úÖ Successful Logins</h4>
    <div id="successAccounts"></div>

    <h4>‚ùå Failed Logins</h4>
    <div id="failedAccounts"></div>
  </div>

  <!-- COPY TRADING -->
  <div id="copyTrading" class="section">
    <h3>üìã Copy Trading Panel</h3>
    <div id="masterCard" class="card"></div>
    <div id="childAccountsContainer"></div>
  </div>
</main>

<div id="toast">Toast here</div>

<script>
function showTab(id) {
  document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('aside li').forEach(el => el.classList.remove('active'));
  document.querySelector(`aside li[onclick="showTab('${id}')"]`).classList.add('active');
  if (id === 'copyTrading') loadCopyTrading();
}

function handleDropdown(option) {
  if (option === "Logout") window.location.href = "/logout";
  else alert(`${option} clicked`);
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.innerText = msg;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 3000);
}

function addAccount() {
  const name = document.getElementById('clientId').value.trim();
  const api_key = document.getElementById('apiKey').value.trim();
  const api_secret = document.getElementById('apiSecret').value.trim();

  if (!name || !api_key || !api_secret) return alert("Required fields missing");

  fetch('/add-account', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name, api_key, api_secret,
      totp_key: document.getElementById('totpKey').value.trim(),
      email: document.getElementById('emailId').value.trim(),
      mobile: document.getElementById('mobileNo').value.trim()
    })
  }).then(res => res.json()).then(d => {
    showToast(d.message);
    loadAccounts();
  });
}

function loadAccounts() {
  fetch('/get-accounts-details')
    .then(res => res.json())
    .then(data => {
      const success = document.getElementById('successAccounts');
      const failed = document.getElementById('failedAccounts');
      success.innerHTML = '';
      failed.innerHTML = '';

      data.accounts.forEach(acc => {
        const card = document.createElement('div');
        card.className = 'card';
        const pnlColor = acc.pnl >= 0 ? 'green' : 'red';
        card.innerHTML = `
          <b>${acc.name}</b> | Status: ${acc.status ? '‚úÖ' : '‚ùå'}
          | Balance: ‚Çπ${acc.balance || '‚Äî'}
          | PnL: <span class="${pnlColor}">‚Çπ${acc.pnl || 0}</span>
          | AutoLogin: <input type="checkbox" ${acc.autologin ? 'checked' : ''} onchange="toggleAutoLogin('${acc.name}', this.checked)">
          <br/>
          <button class="btn" onclick="refreshSession('${acc.name}')">Reconnect</button>
          <button class="btn" onclick="editAccount('${acc.name}')">Edit</button>
          <button class="btn" onclick="deleteAccount('${acc.name}')">Delete</button>`;
        (acc.status ? success : failed).appendChild(card);
      });
    });
}

function toggleAutoLogin(clientId, val) {
  fetch('/toggle-autologin', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ client_id: clientId, autologin: val })
  });
}

function refreshSession(clientId) {
  fetch('/refresh-session', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ client_id: clientId })
  }).then(res => res.json()).then(d => {
    showToast(d.message || "Session refreshed");
    loadAccounts();
  });
}

function deleteAccount(clientId) {
  if (!confirm(`Delete ${clientId}?`)) return;
  fetch('/delete-account', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ client_id: clientId })
  }).then(res => res.json()).then(d => {
    showToast(d.message || "Account deleted");
    loadAccounts();
  });
}

// COPY TRADING SECTION
function loadCopyTrading() {
  fetch('/accounts').then(res => res.json()).then(data => {
    const master = data.find(a => a.is_master);
    const children = data.filter(a => !a.is_master);
    const pnlColor = master.pnl >= 0 ? 'green' : 'red';

    document.getElementById('masterCard').innerHTML = `
      <b>Master: ${master.name}</b> | Copy:
      <input type="checkbox" ${master.copy_enabled ? 'checked' : ''} onchange="toggleMasterCopy(this.checked)">
      | Balance: ‚Çπ${master.balance} | PnL: <span class="${pnlColor}">‚Çπ${master.pnl}</span>
      <br/>
      <button class="btn" onclick="console.log('Orderbook')">Orderbook</button>
      <button class="btn" onclick="console.log('Positions')">Positions</button>
      <button class="btn" onclick="console.log('Change Master')">Change Master</button>
    `;

    const container = document.getElementById('childAccountsContainer');
    container.innerHTML = '';
    children.forEach(acc => {
      const pnlColor = acc.pnl >= 0 ? 'green' : 'red';
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <b>Child: ${acc.name}</b> | AutoLogin:
        <input type="checkbox" ${acc.autologin ? 'checked' : ''} onchange="toggleAutoLogin('${acc.name}', this.checked)">
        | Balance: ‚Çπ${acc.balance} | PnL: <span class="${pnlColor}">‚Çπ${acc.pnl}</span>
        | Multiplier: <input type="number" value="${acc.multiplier}" step="0.1" onchange="updateMultiplier('${acc.name}', this.value)">
        | Copy: <input type="checkbox" ${acc.copy_enabled ? 'checked' : ''} onchange="toggleCopy('${acc.name}', this.checked)">
        <br/>
        <button class="btn" onclick="console.log('Exit')">Exit</button>
        <button class="btn" onclick="editAccount('${acc.name}')">Edit</button>
        <button class="btn" onclick="deleteAccount('${acc.name}')">Delete</button>`;
      container.appendChild(div);
    });
  });
}

function toggleMasterCopy(val) {
  fetch('/toggle-master-copy', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ enabled: val })
  });
}

function updateMultiplier(clientId, val) {
  fetch('/update-multiplier', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ client_id: clientId, multiplier: parseFloat(val) })
  });
}

window.onload = loadAccounts;
</script>

</body>
</html>
