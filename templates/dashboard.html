<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OpenAlgo Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <style>
    body { display: flex; margin: 0; font-family: Arial; background-color: #f0f2f5; }
    aside { width: 220px; background-color: #1c1c1c; color: white; height: 100vh; padding-top: 20px; position: fixed; }
    aside h2 { text-align: center; color: #61dafb; }
    aside ul { list-style: none; padding: 0; }
    aside li { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #444; }
    aside li:hover { background-color: #333; }
    main { margin-left: 220px; padding: 20px; flex-grow: 1; }
    section { display: none; }
    section.active { display: block; }
    .status-box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .status-box h3 { margin-top: 0; }
    .btn { background: #007BFF; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #0056b3; }
    .account-row { margin-top: 10px; }
    select, input { margin-top: 5px; padding: 6px; border-radius: 4px; border: 1px solid #ccc; width: 200px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #007BFF; color: white; }
    iframe { border: none; margin-top: 10px; }
    .live-orders { font-size: 14px; margin-top: 5px; color: #555; }
  </style>
</head>
<body>
  <aside>
    <h2>OpenAlgo</h2>
    <ul>
      <li onclick="showTab('copy')"><i class="fa-solid fa-repeat"></i> Copy Trading</li>
      <li onclick="showTab('login')"><i class="fa-solid fa-lock"></i> Zerodha Login</li>
      <li onclick="showTab('orders')"><i class="fa-solid fa-chart-column"></i> Orders</li>
      <li onclick="showTab('telegram')"><i class="fa-solid fa-envelope"></i> Telegram</li>
      <li onclick="confirmLogout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</li>
    </ul>
  </aside>

  <main>
    <section id="login" class="active">
      <div class="status-box">
        <h3><i class="fa-solid fa-lock"></i> Login to Zerodha</h3>
        <div id="loginButtons"></div>
        <div id="accountStatus"></div>
      </div>
    </section>
  </main>

  <script>
    const socket = io();
    socket.on("update_pnl", (data) => updatePnl(data.pnl));
    socket.on("new_order", (data) => addOrderRow(data));

    function showTab(id) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function confirmLogout() {
      if (confirm("Are you sure you want to logout?")) {
        window.location.href = "/logout";
      }
    }

    function safeLogin(account) {
      fetch('/health-check').then(() => {
        window.open(`/zerodha-login/${account}`, '_blank');
      });
    }

    function toggleAccount(account, isEnabled) {
      fetch(`/toggle-account/${account}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled: isEnabled })
      }).then(r => r.text()).then(alert);
    }

    function updateCreds(name) {
      const api_key = document.getElementById(`key-${name}`).value;
      const api_secret = document.getElementById(`secret-${name}`).value;
      const access_token = document.getElementById(`token-${name}`).value;
      fetch(`/update-creds/${name}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ api_key, api_secret, access_token })
      }).then(res => res.text()).then(alert);
    }

    function clearCreds(name) {
      if (confirm(`Clear credentials for ${name}?`)) {
        fetch(`/clear-creds/${name}`, { method: 'POST' })
          .then(res => res.text()).then(alert);
      }
    }

    function loadAccounts() {
      fetch('/config.yaml')
        .then(res => res.text())
        .then(text => {
          const names = [...text.matchAll(/- name: (\w+)/g)].map(m => m[1]);
          const masterMatch = text.match(/master:\s*\n\s*name:\s*(\w+)/);
          const master = masterMatch ? masterMatch[1] : "master";

          const loginDiv = document.getElementById('loginButtons');
          loginDiv.innerHTML = '';

          const masterBtn = document.createElement('div');
          masterBtn.className = 'account-row';
          masterBtn.innerHTML = `
            <button class="btn" onclick="safeLogin('${master}')">Login: ${master}</button>
            <label><input type="checkbox" onchange="toggleAccount('${master}', this.checked)" checked> Enabled</label>
            <div class="live-orders" id="status-${master}">-</div>
            <div style="margin-top:10px;">
              <input type="text" id="key-${master}" placeholder="API Key"><br>
              <input type="text" id="secret-${master}" placeholder="API Secret"><br>
              <input type="text" id="token-${master}" placeholder="Access Token"><br>
              <button class="btn" onclick="updateCreds('${master}')">üíæ Save</button>
              <button class="btn" onclick="clearCreds('${master}')" style="background-color:#dc3545;">üóëÔ∏è Clear</button>
            </div>`;
          loginDiv.appendChild(masterBtn);

          names.forEach(name => {
            const div = document.createElement('div');
            div.className = 'account-row';
            div.innerHTML = `
              <button class="btn" onclick="safeLogin('${name}')">Login: ${name}</button>
              <label><input type="checkbox" onchange="toggleAccount('${name}', this.checked)" checked> Enabled</label>
              <div class="live-orders" id="status-${name}">-</div>
              <div style="margin-top:10px;">
                <input type="text" id="key-${name}" placeholder="API Key"><br>
                <input type="text" id="secret-${name}" placeholder="API Secret"><br>
                <input type="text" id="token-${name}" placeholder="Access Token"><br>
                <button class="btn" onclick="updateCreds('${name}')">üíæ Save</button>
                <button class="btn" onclick="clearCreds('${name}')" style="background-color:#dc3545;">üóëÔ∏è Clear</button>
              </div>
            `;
            loginDiv.appendChild(div);
          });
        });
    }

    loadAccounts();
  </script>
</body>
</html>
